<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>ARTE MODERNO - Generador de Enunciados by © 2025 Tabja Games</title>
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{
      --bg:#0b1020;--panel:#111a2b;--muted:#99a3b4;--text:#e7eefc;
      --accent:#0ea5e9;--accent2:#22c55e;
      --verb:#ff4d4d; --adj:#7CFC00; --place:#ffe066; --event:#b266ff; --scene:#ffb347;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial;
      color:var(--text);background:linear-gradient(180deg,#0b1020,#0b1428) fixed;
    }
    header{
      position:sticky;top:0;background:rgba(9,13,26,.7);backdrop-filter:blur(8px);
      border-bottom:1px solid rgba(255,255,255,.05);z-index:10
    }
    .container{max-width:820px;margin:0 auto;padding:16px}
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 6px 30px rgba(0,0,0,.25)
    }
    .title{font-size:20px;font-weight:700;display:flex;gap:10px;align-items:center;justify-content:space-between}
    .muted{color:var(--muted)}
    .btn{
      appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:700;color:var(--text);
      background:transparent;border:1px solid rgba(255,255,255,.12);cursor:pointer;transition:background .15s,color .15s,font-weight .05s;font-size:14px;
    }
    .btn:hover{background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(1px)}
    .inline{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input{
      width:100%;background:#0f182a;color:var(--text);border:1px solid rgba(255,255,255,.14);border-radius:12px;padding:10px 12px;font-size:15px;
    }
    .out{
      font-size:22px;line-height:1.45;background:#0b1426;border-radius:14px;padding:14px;border:1px dashed rgba(255,255,255,.15)
    }
    footer{opacity:.7;padding:24px 12px;text-align:center;font-size:12px;position:relative}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px;border:1px solid rgba(255,255,255,.2);padding:2px 6px;border-radius:6px;background:#0e1628}
    .tag{display:inline-block;padding:.25rem .6rem;border:1px solid rgba(255,255,255,.18);border-radius:999px;margin:0.25rem;font-size:13px;color:var(--muted);}
    .char{ color:#4cc9f0; } .verb{ color:var(--verb); } .adj{ color:var(--adj); } .place{ color:#ffe066; } .event{ color:#b266ff; } .scene{ color:#ffb347; }

    #footerBtns{position:absolute;right:12px;bottom:8px;opacity:0;transition:opacity .3s;display:flex;gap:6px;}
    footer:hover #footerBtns{opacity:0.5;}
    #footerBtns .btn{font-size:10px;padding:4px 8px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.05);}
    .btn span { font-weight: bold; }
    .letter-p{color:#4cc9f0}.letter-v{color:#ff4d4d}.letter-a{color:#7CFC00}.letter-l{color:#ffe066}

    /* Overlay inicial — AHORA visible por defecto */
    #lobbyOverlay{
      position:fixed; inset:0; background:rgba(11,16,32,.92);backdrop-filter: blur(8px);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }

    /* Toast */
    #toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px);
      background:rgba(20,28,48,.96); border:1px solid rgba(255,255,255,.15); color:var(--text);
      padding:10px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      opacity:0; transition:opacity .25s, transform .25s; z-index:1200; pointer-events:none; font-weight:700;
    }
    #toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* Jugadores (vertical + group-colored + score) */
    .players-wrap{ display:flex; flex-direction:column; gap:8px; }
    .players-title-actions{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .playerChip{
      position:relative;
      display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid rgba(255,255,255,.14);
      border-radius:12px;background:rgba(255,255,255,.04); width:100%;
      --gc:#64748b;
    }
    .playerChip::before{
      content:"";
      position:absolute; left:0; top:0; bottom:0; width:4px;
      background:var(--gc);
      border-top-left-radius:12px;border-bottom-left-radius:12px;
      opacity:.95;
    }
    .playerChip .dot{ width:8px;height:8px;border-radius:50%;background:var(--accent2) }
    .groupBadge{
      padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px;
      background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
    }
    .playerChip .name{ font-weight:700; display:flex; align-items:center; gap:8px; }
    .playerChip .role{
      font-size:10px;border:1px solid rgba(255,255,255,.2);
      padding:2px 6px;border-radius:999px;opacity:.9
    }
    .scoreBox{
      margin-left:auto; display:flex; align-items:center; gap:6px;
      font-variant-numeric: tabular-nums; user-select:none;
    }
    .score{ min-width:36px; text-align:right; font-weight:800; padding:2px 6px;
      border:1px solid rgba(255,255,255,.18); border-radius:8px; background:#0e1628;
    }
    .scoreBtn{
      width:28px;height:28px;display:flex;align-items:center;justify-content:center;
      border:1px solid rgba(255,255,255,.2); background:rgba(255,255,255,.06);
      border-radius:8px; cursor:pointer; font-weight:900; font-size:14px;
    }
    .scoreBtn[disabled]{opacity:.35; cursor:not-allowed}

    /* Enunciado por grupo (línea con badge de color) */
    .lineGroup{
      display:flex; align-items:center; gap:10px; margin:6px 0;
    }
    .lineGroup .gBadge{
      padding:2px 8px; border:1px solid rgba(255,255,255,.18); border-radius:8px; background:#0e1628; font-weight:800; font-size:12px; white-space:nowrap;
    }
  </style>
</head>
<body>
  <header>
    <div class="container" style="display:flex;flex-direction:column;gap:6px">
      <div class="inline" style="justify-content:space-between; gap:12px">
        <div class="title" style="flex:1; min-width:0">
          🎨 ARTE MODERNO - Generador de Enunciados
          <span class="muted">by © 2025 Tabja Games</span>
        </div>
        <span id="roomBadge" class="muted" style="display:none;font-weight:700;padding:4px 10px;border:1px solid rgba(255,255,255,.15);border-radius:999px;">Sala: -----</span>
      </div>
      <div id="leaveRow" class="inline" style="display:none;justify-content:flex-end;">
        <button class="btn" id="btnLeave">Salir de la sala</button>
      </div>
    </div>
  </header>

  <!-- Overlay de inicio (visible por defecto; se oculta al entrar a una sala) -->
  <div id="lobbyOverlay">
    <section class="card" style="max-width:520px; width:92%; padding:20px">
      <div class="title" style="margin-bottom:10px">Crear o unirse a una sala</div>
      <div class="inline" style="align-items:flex-end; gap:10px; flex-wrap:wrap">
        <div>
          <label class="muted" for="playerName">Tu nombre</label><br>
          <input id="playerName" placeholder="Ej: Tabja" style="max-width:180px">
        </div>
        <div>
          <label class="muted" for="lobbyCodeInput">Código de sala</label><br>
          <input id="lobbyCodeInput" placeholder="ABCD2" style="max-width:140px;text-transform:uppercase">
        </div>
        <button class="btn" id="btnCreateLobby">Crear sala</button>
        <button class="btn" id="btnJoinLobby">Unirse</button>
      </div>
      <div class="muted" id="lobbyStatus" style="margin-top:10px; min-height:20px"></div>
    </section>
  </div>

  <main class="container" style="padding-top:18px">
    <section class="card">
      <div style="display:grid;gap:10px">
        <div class="inline">
          <button class="btn" id="btnP">PERSONAJE</button>
          <button class="btn" id="btnFusion">FUSIÓN</button>
          <button class="btn" id="btnEvento">EVENTOS</button>
          <button class="btn" id="btnEscena">ESCENAS</button>
        </div>
        <div class="inline">
          <button class="btn" id="btnPV"><span class="letter-p">P</span> + <span class="letter-v">V</span></button>
          <button class="btn" id="btnPA"><span class="letter-p">P</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPL"><span class="letter-p">P</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVA"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span></button>
          <button class="btn" id="btnPAL"><span class="letter-p">P</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-l">L</span></button>
          <button class="btn" id="btnPVAL"><span class="letter-p">P</span> + <span class="letter-v">V</span> + <span class="letter-a">A</span> + <span class="letter-l">L</span></button>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="title">Enunciado a dibujar</div>
      <div id="salida" class="out" style="margin-top:10px;white-space:pre-wrap"></div>
      <div id="historial" style="margin-top:10px"></div>
      <div id="testlog" class="muted" style="margin-top:10px"></div>
    </section>

    <!-- Jugadores conectados -->
    <section class="card" id="playersCard" style="margin-top:14px; display:none">
      <div class="title">
        <span>Jugadores conectados</span>
        <div class="players-title-actions">
          <button class="btn" id="btnGrupos" title="Formar parejas asignando Grupo A, B, C…">Generar grupos</button>
        </div>
      </div>
      <div id="playersList" class="players-wrap" style="margin-top:10px"></div>
    </section>
  </main>

  <footer>
    Hecho para móvil y desktop.  
    Atajos: <span class="kbd">Ctrl/Cmd + 1..6</span>
    <div id="footerBtns">
      <button class="btn" id="btnCopiar">Copiar</button>
      <button class="btn" id="btnTest">Test</button>
    </div>
  </footer>

  <!-- Toast element -->
  <div id="toast"></div>

  <script>
    /* === Generadores locales === */
    const PERSONAJES=['Goku','Vegeta','Piccolo','Freezer','Monkey D. Luffy','Roronoa Zoro','Sanji','Nami','Naruto Uzumaki','Sasuke Uchiha','Kakashi Hatake','Ichigo Kurusaki','Satoru Gojo','Eren Yeager','Levi Ackerman','Shigeo Kageyama','Saitama','Edward Elric','Tanjiro Kamado','Nezuko Kamado','Kenshin Himura','Joseph Joestar','Guts','Ash Ketchum','Yugi Muto','Bob Esponja','Patricio Estrella','Calamardo','Arnold Shortman','Aang','Timmy Turner','Jimmy Neutron','Johnny Bravo','Mojo Jojo','Perry El Ornitorrinco','Optimus Prime','Mickey Mouse','Bugs Bunny','El Pato Donald','Felix El Gato','Winnie-the-Pooh','Charlie Brown','Snoopy','Hello Kitty','Dora La Exploradora','Peppa Pig','Homero Simpson','Rick Sanchez','Morty Smith','Eric Cartman','Buzz Lightyear','Mike Wazowski','Shrek','Wall-E','Stitch','Nemo','Elsa','Simba','Luke Skywalker','Darth Vader','Yoda','E.T.','John Wick','Neo','Indiana Jones','El Terminator','Jack Sparrow','Borat','Charlie Chaplin','Jason Voorhees','Chucky','Freddy Krueger','Jigsaw','Pennywise','Edward Scissorhands','Jack Skellington','Godzilla','El Xenomorfo','Superman','Spider-Man','Batman','Wolverine','Hulk','Venom','Thor','El Joker','Albert Einstein','Leo Messi','Napoleón Bonaparte','Atahualpa','Hitler','Michael Jackson','Freddie Mercury','Beethoven','Pedro Castillo','Donald Trump','Gandalf','Frodo Baggins','Gollum','Harry Potter','Voldemort','Willy Wonka','Cenicienta','Rapunzel','Aladino','Dracula','Frankenstein','Wednesday Addams','El Jorobado de Notre Dame','James Bond','Don Quijote de la Mancha','El Gato con Botas','Robin Hood','Pinnochio','Tarzán','Tralalero Tralalá','Brr Brr Patapím','Chimpanzini Bananini','Tung Tung Tung Sahur','Bombardino Crocodilo','La Vaca Saturno Saturnita','Clippy','El Chavo del Ocho','Jon Snow','Walter White','La Rana René','Pikachu','Mario','Bowser','Yoshi','Donkey Kong','Kirby','Link','Zelda','Samus Aran','Sonic','Crash Bandicoot','Mega Man','Pac-Man','Leon S. Kennedy','Lara Croft','El Amongus','Santa Claus','Dios','Atlas','Zeus','Poseidón','Hércules','Pegaso','El Kraken','El Cíclope','El Minotauro','El Cerbero','El Fénix','El Leviatán','El Fenrir','La Medusa','La Muerte','El Yeti','El Chupacabras','Un Ángel','Un Demonio','Un Centauro','Un Gólem','Un Basilisco','Un Grifo','Un Ogro','Una Sirena','Una Arpía','Una Hidra','Una Quimera','Un Licántropo','Un Unicornio','Una Bruja','Un Dragón','Una Valquiria','Un Elfo','Un Gnomo','Un Duende','Un Hada','Un Fantasma','Un Vampiro','Un Zombie','Una Momia','Un Esqueleto','Un Mago'];
    const VERBOS=['leyendo','patinando','esquiando','surfeando','navegando','cabalgando','pedaleando','nadando','bailando','pescando','regando','componiendo','escribiendo','cocinando','conduciendo','cenando','trabajando','jugando','barriendo','corriendo','caminando','saltando','trepando','luchando','descansando','durmiendo','marchando','volando','bebiendo','fumando','vomitando','masturbando','orinando','cagando','copulando','muriendo','naciendo','pariendo','gritando','llorando','cantando','pensando','rezando','vendiendo','saludando','boxeando'];
    const ADJETIVOS=['content@','enojad@','asustad@','preocupad@','desnud@','cansad@','confundid@','excitad@','aburrid@','sorprendid@','doblad@','sentad@','parad@','arrodillad@','echad@','suspendid@','tembland@','derretid@','herid@','atad@','enamorad@','relajad@','borrach@','nervios@','enferm@','descalz@','tens@'];
    const LUGARES=['bajo el agua','bajo el sol','bajo la luna','bajo la lluvia','bajo la tierra','bajo las estrellas','bajo un árbol','bajo un puente','sobre un tren','sobre una torre','sobre una cama','sobre una mesa','sobre un techo','sobre las nubes','tras los arbustos','tras una roca','tras la ventana','tras las rejas','en el campo','en el mar','en el espacio','en el futuro','en el pasado','en el infierno','en el cielo','en la ciudad','en la montaña','en la playa','en la selva','en el Valhalla','en el Olimpo','en la corte','en el fin del mundo','en la prehistoria','en un baño','en un bosque','en un colegio','en un desierto','en un gimnasio','en un zoológico','en un pantano','en una tormenta','en una oficina','en un bar','en un hospital','en un cementerio','en un parque','en un balcón','en una granja','en un teatro','en una biblioteca','en un cine','en un avión','en un helicóptero','en un cohete','en un castillo','en un mercado','en una pradera','en un globo','en un burdel','en un laboratorio','en una prisión','en un jardín','en Egipto','en Francia','en Japón','en Perú','en Australia','en la Antártida'];
    const EVENTOS=['El nacimiento de','La muerte de','La creación de','La destrucción de','La victoria de','La derrota de','El sacrificio de','La furia de','La caída de','El sueño de','El regreso de','La invasión de','El ritual de','La persecución de','La evolución de','Los ojos de','El beso de','El rapto de','La danza de','La casa de','La habitación de','El baño de','Retrato de','La venganza de','La tortura de','El castigo de','La traición de','La ejecución de','El asesinato de','La rebelión de','El entierro de','La confesión de','El cumpleaños de','El concierto de','El bautizo de','El Baby Shower de','La aventura de'];
    const ESCENAS=['Guerra','Paz','Caos','Orden','Odio','Amor','Soledad','Invierno','Verano','Otoño','Primavera','Amanecer','Atardecer','Anochecer','Terror','Incendio','Duelo','Batalla','Matrimonio','Despedida','Bienvenida','Encuentro','Apocalipsis','Tragedia','Desastre','Catástrofe','Exterminio','Masacre','Tratado','Barbacoa','Picnic','Banquete','Fiesta','Excursión','Olimpiadas','Carnaval','Desfile','Venganza','Tortura','Castigo','Traición','Ejecución','Asesinato','Revolución','Funeral','Confesión','Cumpleaños','Concierto','Bautizo','Baby Shower','Aventura'];

    const byId=id=>document.getElementById(id);
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return((t^t>>>14)>>>0)/4294967296}}
    function rng(seed){if(!seed)return Math.random;let n=0;for(let i=0;i<seed.length;i++)n=(n*31+seed.charCodeAt(i))>>>0;return mulberry32(n)}
    const pick=(arr,R)=>arr[Math.floor(R()*arr.length)];
    const esc=s=>s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    window.esc = esc;

    const wrapChar=name=>`<span class="char">${esc(name)}</span>`;
    const wrapVerb=v=>`<span class="verb">${esc(v)}</span>`;
    const wrapAdj=a=>`<span class="adj">${esc(a)}</span>`;
    const wrapPlace=l=>`<span class="place">${esc(l)}</span>`;
    const wrapEvent=e=>`<span class="event">${esc(e)}</span>`;
    const wrapScene=s=>`<span class="scene">${esc(s)}</span>`;

    function genPVAL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${a} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPV(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R);return{ text:`${p} ${v}`, html:`${wrapChar(p)} ${wrapVerb(v)}` }}
    function genPA(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${a}`, html:`${wrapChar(p)} ${wrapAdj(a)}` }}
    function genPL(R){const p=pick(PERSONAJES,R),l=pick(LUGARES,R);return{ text:`${p} ${l}`, html:`${wrapChar(p)} ${wrapPlace(l)}` }}
    function genPAL(R){const p=pick(PERSONAJES,R),a=pick(ADJETIVOS,R),l=pick(LUGARES,R);return{ text:`${p} ${a} ${l}`, html:`${wrapChar(p)} ${wrapAdj(a)} ${wrapPlace(l)}` }}
    function genPVA(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),a=pick(ADJETIVOS,R);return{ text:`${p} ${v} ${a}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapAdj(a)}` }}
    function genPVL(R){const p=pick(PERSONAJES,R),v=pick(VERBOS,R),l=pick(LUGARES,R);return{ text:`${p} ${v} ${l}`, html:`${wrapChar(p)} ${wrapVerb(v)} ${wrapPlace(l)}` }}
    function genFusion(R){let p1=pick(PERSONAJES,R);let p2;do{p2=pick(PERSONAJES,R)}while(p2===p1);return{ text:`${p1} + ${p2}`, html:`${wrapChar(p1)} + ${wrapChar(p2)}` }}
    function genP(R){const p=pick(PERSONAJES,R);return{ text:`${p}`, html:`${wrapChar(p)}` }}
    function genEvento(R){const e=pick(EVENTOS,R),p=pick(PERSONAJES,R);return{ text:`${e} ${p}`, html:`${wrapEvent(e)} ${wrapChar(p)}` }}
    function genEscena(R){const s=pick(ESCENAS,R),l=pick(LUGARES,R);return{ text:`${s} ${l}`, html:`${wrapScene(s)} ${wrapPlace(l)}` }}

    const recent=[]; let lastCopyText='';

    function generarUno(mode){
      const R=rng();
      switch(mode){
        case'PV':return genPV(R);
        case'PA':return genPA(R);
        case'PL':return genPL(R);
        case'PAL':return genPAL(R);
        case'PVA':return genPVA(R);
        case'PVL':return genPVL(R);
        case'FUSION':return genFusion(R);
        case'P':return genP(R);
        case'EVENTO':return genEvento(R);
        case'ESCENA':return genEscena(R);
        default:return genPVAL(R);
      }
    }

    function generarN(mode,n){
      const R=rng();
      const gens={PVAL:genPVAL,PV:genPV,PA:genPA,PL:genPL,PAL:genPAL,PVA:genPVA,PVL:genPVL,FUSION:genFusion,P:genP,EVENTO:genEvento,ESCENA:genEscena};
      const fn=gens[mode]||genPVAL;
      const out=Array.from({length:n},()=>fn(R));
      byId('salida').innerHTML=out.map(o=>o.html).join('<br>');
      const texts=out.map(o=>o.text);
      lastCopyText=texts.join('\n');
      recent.push(...texts); renderHistorial();
    }

    function renderHistorial(){
      const last=recent.slice(-10).reverse();
      byId('historial').innerHTML=last.length ?
        ( `<div class="muted">Últimos (${last.length}):</div>` + last.map(x=>`<span class="tag">${esc(x)}</span>`).join('') )
        : '';
    }

    // Toast + sonidos
    const toastEl = document.getElementById('toast');
    let toastTimer=null, __uiAudioCtx;
    function showToast(msg){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove('show'), 2200);
    }
    function playClick(){
      try{
        if(!__uiAudioCtx){ __uiAudioCtx = new (window.AudioContext||window.webkitAudioContext)(); }
        const ctx = __uiAudioCtx;
        const osc = ctx.createOscillator();
        const gain = ctx.createGain();
        osc.type = 'triangle'; osc.frequency.value = 320;
        gain.gain.setValueAtTime(0.0001, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.15, ctx.currentTime + 0.005);
        gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.08);
        osc.connect(gain).connect(ctx.destination); osc.start(); osc.stop(ctx.currentTime + 0.09);
      }catch(e){}
    }
    (function(){ document.querySelectorAll('button').forEach(b=> b.addEventListener('click', playClick, {capture:true})); })();

    byId('btnCopiar').onclick=async()=>{ if(!lastCopyText) return; await navigator.clipboard.writeText(lastCopyText); }
    byId('btnTest').onclick=()=>{
      const modes=['PVAL','PV','PA','PL','PAL','PVA','PVL','FUSION','P','EVENTO','ESCENA'];
      let report='Pruebas:'; for(const m of modes){
        let ok=0,total=100; for(let i=0;i<total;i++){ const {text,html}=generarUno(m); if(typeof text==='string'&&text.length>0&&typeof html==='string'&&html.length>0) ok++; }
        report+=`\n• ${m}: ${ok}/${total} generados correctamente`;
      }
      byId('testlog').textContent=report;
    };
    document.addEventListener('keydown',e=>{
      if((e.metaKey||e.ctrlKey)){
        if(e.key==='1'){e.preventDefault();generarN('PVAL',1);} 
        if(e.key==='2'){e.preventDefault();generarN('PV',1);}   
        if(e.key==='3'){e.preventDefault();generarN('PA',1);}   
        if(e.key==='4'){e.preventDefault();generarN('PL',1);}   
        if(e.key==='5'){e.preventDefault();generarN('FUSION',1);} 
        if(e.key==='6'){e.preventDefault();generarN('P',1);}    
      }
    });

    generarN('PVAL',1);
  </script>

  <!-- 🔥 Firebase Realtime (grupos, colores, score y generación por grupo) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, onDisconnect, push, get, off, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHEBnKMHJt9npV6NeHzSjWdJtBE9EUmwQ",
      authDomain: "arte-moderno-5ff8a.firebaseapp.com",
      projectId: "arte-moderno-5ff8a",
      storageBucket: "arte-moderno-5ff8a.firebasestorage.app",
      messagingSenderId: "478321511301",
      appId: "1:478321511301:web:6b46294944397c0ce952ec",
      measurementId: "G-BP2SKW1881"
    };

    const appFB = initializeApp(firebaseConfig);
    const db = getDatabase(appFB);

    function getClientId(){
      const k="am_client_id";
      let id=localStorage.getItem(k);
      if(!id){ id = Math.random().toString(36).slice(2); localStorage.setItem(k,id); }
      return id;
    }
    const clientId = getClientId();

    let lobbyCode = null;
    let isHost = false;
    let prevIsHost = false;
    let playersConnected = 0;
    let currentConnRef = null;
    let lobbyRef = null;
    let lobbyCallback = null;
    let lastLobbyState = null;

    const $ = (id)=> document.getElementById(id);
    const statusEl = $("lobbyStatus");
    const badgeEl  = $("roomBadge");
    const overlayEl = $("lobbyOverlay");
    const leaveRow = $("leaveRow");
    const playersCard = $("playersCard");
    const playersList = $("playersList");
    const btnGrupos = $("btnGrupos");

    const LS_CODE_KEY = "am_lobby_code";

    function makeCode(){
      const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      return Array.from({length:5},()=> chars[Math.floor(Math.random()*chars.length)]).join("");
    }

    // ====== Colores por grupo ======
    const GROUP_PALETTE = ['#60a5fa','#f472b6','#34d399','#fbbf24','#a78bfa','#fb7185','#22d3ee','#f59e0b','#4ade80','#e879f9'];
    const hexToRgb = (hex)=>{ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex); return m?{r:parseInt(m[1],16),g:parseInt(m[2],16),b:parseInt(m[3],16)}:{r:100,g:100,b:100}; };
    const rgba = (hex, a)=>{ const {r,g,b}=hexToRgb(hex); return `rgba(${r}, ${g}, ${b}, ${a})`; };
    const groupColor = (letter)=>{
      if(!letter) return '#64748b';
      const idx = Math.max(0, letter.charCodeAt(0) - 65);
      return GROUP_PALETTE[idx % GROUP_PALETTE.length];
    };

    function setLobbyCode(code){
      lobbyCode = code;
      localStorage.setItem(LS_CODE_KEY, code);
      badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
      leaveRow.style.display='flex';
      overlayEl.style.display='none';
      playersCard.style.display='block';
    }
    function clearLobbyCode(){
      lobbyCode = null;
      localStorage.removeItem(LS_CODE_KEY);
      badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
      leaveRow.style.display='none';
      overlayEl.style.display='flex';           /* ← siempre vuelve a mostrarse */
      playersCard.style.display='none';
      lastLobbyState = null;
    }

    /* Presencia por pestaña */
    function setupPresence(code){
      if (!code) return;

      if (currentConnRef) { try { onDisconnect(currentConnRef).cancel(); } catch(e){} currentConnRef = null; }

      const infoRef = ref(db, ".info/connected");
      onValue(infoRef, (snap)=>{
        if (snap.val() === true) {
          const connRef = push(ref(db, `lobbies/${code}/players/${clientId}/connections`));
          currentConnRef = connRef;
          set(connRef, true);
          onDisconnect(connRef).remove();
          update(ref(db, `lobbies/${code}/players/${clientId}`), { connected: true });
        }
      });
    }

    function updateHostUI(){
      const hostOrSolo = isHost || playersConnected <= 1;
      const ids = [
        'btnP','btnFusion','btnEvento','btnEscena',
        'btnPV','btnPA','btnPL','btnPVA','btnPAL','btnPVL','btnPVAL',
        'btnGrupos'
      ];
      const disabled = (lobbyCode && !hostOrSolo);
      ids.forEach(id=>{
        const el = $(id);
        if(!el) return;
        el.disabled = disabled;
        el.style.opacity = disabled ? 0.5 : '';
        el.style.pointerEvents = disabled ? 'none' : '';
      });

      playersList?.querySelectorAll('.scoreBtn').forEach(b=> b.disabled = !hostOrSolo);
    }

    const clampScore = (n)=> Math.max(0, Math.min(999, n|0));

    function getActiveGroupsFromState(state){
      const playersObj = state?.players || {};
      return [...new Set(
        Object.values(playersObj)
          .filter(p=>p && p.connections && Object.keys(p.connections).length>0)
          .map(p=> p.group ? String(p.group).toUpperCase() : null)
          .filter(Boolean)
      )].sort();
    }

    function renderPlayers(state){
      if(!playersCard || !playersList) return;

      const playersObj = state.players || {};
      const items = Object.entries(playersObj).map(([pid,p])=>{
        const connected = !!(p && p.connections && Object.keys(p.connections).length > 0);
        return {
          id: pid,
          name: (p && p.name) || "Jugador",
          score: clampScore((p && p.score)!=null ? p.score : 0),
          group: p && p.group ? String(p.group).toUpperCase() : null,
          connected,
          isAdmin: state.hostId === pid
        };
      }).filter(x=>x.connected);

      if(items.length === 0){
        playersList.innerHTML = `<span class="muted">Nadie conectado aún…</span>`;
      }else{
        const escSafe = window.esc || ((s)=>String(s));
        playersList.innerHTML = items.map(x=>{
          const col = groupColor(x.group);
          const bg = rgba(col, 0.22);
          const bd = rgba(col, 0.55);
          return `
          <div class="playerChip" data-id="${x.id}" title="${escSafe(x.name)}${x.isAdmin?' • ADMIN':''}" style="--gc:${col}">
            <span class="dot" aria-label="online"></span>
            <span class="groupBadge" style="background:${bg};border-color:${bd}">${x.group ? `Grupo ${escSafe(x.group)}` : '—'}</span>
            <span class="name">
              ${escSafe(x.name)}
              ${x.isAdmin ? `<span class="role">ADMIN</span>` : ``}
            </span>

            <div class="scoreBox">
              <button class="scoreBtn" data-action="dec" data-id="${x.id}">−</button>
              <span class="score" data-id="${x.id}">${String(x.score).padStart(2,'0')}</span>
              <button class="scoreBtn" data-action="inc" data-id="${x.id}">+</button>
            </div>
          </div>
        `}).join("");
      }

      const hostOrSolo = isHost || playersConnected <= 1;
      playersList.querySelectorAll('.scoreBtn').forEach(b=> b.disabled = !hostOrSolo);

      playersCard.style.display = lobbyCode ? 'block' : 'none';
    }

    // ======== Generación por grupo (usa el último estado del lobby) ========
    function buildGroupedOutput(mode){
      const state = lastLobbyState;
      const groups = getActiveGroupsFromState(state);
      if(!groups || groups.length===0) return null;

      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];

      const now = Date.now();
      const linesHtml = [];
      const linesText = [];

      for(const g of groups){
        const R = rng(`${lobbyCode}-${g}-${now}`);
        const { html, text } = fn(R);

        const col = groupColor(g);
        const bg = rgba(col, 0.22);
        const bd = rgba(col, 0.55);

        linesHtml.push(`<div class="lineGroup">
          <span class="gBadge" style="background:${bg};border-color:${bd}">Grupo ${g}</span>
          <span>${html}</span>
        </div>`);
        linesText.push(`Grupo ${g}: ${text}`);
      }

      return { html: linesHtml.join(""), text: linesText.join("\n") };
    }

    /* + / − puntaje */
    playersList?.addEventListener('click', async (e)=>{
      const btn = e.target.closest('.scoreBtn');
      if(!btn) return;

      const hostOrSolo = isHost || playersConnected <= 1;
      if(!hostOrSolo) return;

      const pid = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if(!pid || !action || !lobbyCode) return;

      try{
        const scoreEl = playersList.querySelector(`.score[data-id="${pid}"]`);
        let current = 0;
        if(scoreEl){
          current = parseInt(scoreEl.textContent,10);
          if(Number.isNaN(current)) current = 0;
        }else{
          const snap = await get(ref(db, `lobbies/${lobbyCode}/players/${pid}/score`));
          current = clampScore(snap.val() ?? 0);
        }

        const delta = action === 'inc' ? 1 : -1;
        const next = clampScore(current + delta);
        if(next === current) return;

        await update(ref(db, `lobbies/${lobbyCode}/players/${pid}`), { score: next });
      }catch(err){
        console.warn('No se pudo actualizar el score:', err);
        if(window.showToast) window.showToast('No se pudo actualizar el puntaje');
      }
    });

    function watchLobby(code){
      if (lobbyRef && lobbyCallback){
        off(lobbyRef, 'value', lobbyCallback);
        lobbyRef = null; lobbyCallback = null;
      }
      lobbyRef = ref(db, `lobbies/${code}`);
      lobbyCallback = (snap)=>{
        const state = snap.val();
        if(!state) return;

        lastLobbyState = state;

        prevIsHost = isHost;
        isHost = state.hostId === clientId;

        playersConnected = 0;
        if (state.players) {
          playersConnected = Object.values(state.players)
            .filter(p => p && p.connections && Object.keys(p.connections).length > 0).length;
        }

        if (!prevIsHost && isHost && window.showToast) window.showToast("Ahora eres ADMIN");

        badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${code}`;
        leaveRow.style.display='flex';

        if (statusEl) statusEl.textContent = `Sala: ${code} • ${isHost ? "Eres ADMIN" : "Jugador"} • Conectados: ${playersConnected}`;

        if (state.currentOutputHtml && document.getElementById("salida")) document.getElementById("salida").innerHTML = state.currentOutputHtml;

        renderPlayers(state);
        updateHostUI();
      };
      onValue(lobbyRef, lobbyCallback);
    }

    async function createLobby(name){
      const code = makeCode();
      const state = {
        hostId: clientId,
        currentOutputHtml: "",
        currentOutputText: "",
        players: { [clientId]: { name: name||"Host", score: 0, connected: true } },
        createdAt: Date.now()
      };
      await set(ref(db, `lobbies/${code}`), state);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function joinLobby(code, name){
      code = (code||"").toUpperCase().trim();
      if(!code) return alert("Escribe un código de sala");
      const player = { name: name||"Jugador", score: 0, connected: true };
      await update(ref(db, `lobbies/${code}/players/${clientId}`), player);
      setLobbyCode(code);
      watchLobby(code);
      setupPresence(code);
    }

    async function publishOutput(html, text){
      const hostOrSolo = isHost || playersConnected <= 1;
      if(!lobbyCode || !hostOrSolo) return;
      await update(ref(db, `lobbies/${lobbyCode}`), {
        currentOutputHtml: html,
        currentOutputText: text
      });
    }

    async function generarGrupos(){
      if (!lobbyCode) return;
      const hostOrSolo = isHost || playersConnected <= 1;
      if (!hostOrSolo) return;

      const snap = await get(ref(db, `lobbies/${lobbyCode}/players`));
      const playersObj = snap.val() || {};

      const activos = Object.entries(playersObj)
        .filter(([,p]) => p && p.name && p.connections && Object.keys(p.connections).length > 0)
        .map(([pid,p]) => ({ pid, name: p.name }));

      if (activos.length < 2 || activos.length % 2 !== 0) {
        alert("Agrega o quita un jugador para formar grupos parejos");
        return;
      }

      for (let i = activos.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [activos[i], activos[j]] = [activos[j], activos[i]];
      }

      const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      const updates = {};
      for (let i = 0; i < activos.length; i += 2) {
        const letter = letras[i/2] || String(i/2 + 1);
        const a = activos[i], b = activos[i+1];
        updates[`lobbies/${lobbyCode}/players/${a.pid}/group`] = letter;
        updates[`lobbies/${lobbyCode}/players/${b.pid}/group`] = letter;
      }

      await update(ref(db), updates);
    }

    // ====== Botones de generación ======
    const MAP = {
      btnPVAL:'PVAL', btnPV:'PV', btnPA:'PA', btnPL:'PL',
      btnPVA:'PVA', btnPAL:'PAL', btnPVL:'PVL',
      btnFusion:'FUSION', btnP:'P', btnEvento:'EVENTO', btnEscena:'ESCENA'
    };

    function genOne(mode){
      const R = (window.rng ? window.rng() : Math.random);
      const gens = {
        PVAL: window.genPVAL, PV: window.genPV, PA: window.genPA, PL: window.genPL,
        PAL: window.genPAL, PVA: window.genPVA, PVL: window.genPVL,
        FUSION: window.genFusion, P: window.genP, EVENTO: window.genEvento, ESCENA: window.genEscena
      };
      const fn = gens[mode] || gens["PVAL"];
      return fn(R);
    }

    function handleGenerate(mode){
      if(lobbyCode){
        const hostOrSolo = isHost || playersConnected <= 1;
        if(!hostOrSolo) return;

        const grouped = buildGroupedOutput(mode);
        if (grouped){
          publishOutput(grouped.html, grouped.text);
        }else{
          const { html, text } = genOne(mode);
          publishOutput(html, text || '');
        }
      }else{
        const grouped = buildGroupedOutput(mode);
        if (grouped){
          byId("salida").innerHTML = grouped.html;
        }else{
          const { html } = genOne(mode);
          byId("salida").innerHTML = html;
        }
      }
    }

    Object.entries(MAP).forEach(([id,mode])=>{
      const btn = $(id);
      if(btn){ btn.onclick = ()=> handleGenerate(mode); }
    });

    // Botón de grupos en la tarjeta de jugadores
    btnGrupos?.addEventListener('click', generarGrupos);

    // Atajos de teclado (bloquea si no eres host en lobby)
    document.addEventListener('keydown', (e)=>{
      if ((e.metaKey || e.ctrlKey) && ['1','2','3','4','5','6'].includes(e.key)) {
        if (lobbyCode){
          const hostOrSolo = isHost || playersConnected <= 1;
          if (!hostOrSolo) { e.preventDefault(); e.stopPropagation(); }
        }
      }
    }, true);

    // ====== Init ======
    (function initLobbyOnce(){
      const saved = localStorage.getItem(LS_CODE_KEY);
      if(saved){
        overlayEl.style.display = 'none';
        badgeEl.style.display='inline-block'; badgeEl.textContent = `Sala: ${saved}`;
        leaveRow.style.display='flex';
        lobbyCode = saved;
        playersCard.style.display='block';
        watchLobby(saved);
        setupPresence(saved);
      }else{
        overlayEl.style.display = 'flex';   // ← muestra el menú de inicio
        playersCard.style.display='none';
      }
    })();

    // Salir
    async function leaveLobby(){
      if (!lobbyCode) return;
      const code = lobbyCode;

      try{
        if (isHost) {
          const playersSnap = await get(ref(db, `lobbies/${code}/players`));
          const playersObj = playersSnap.val() || {};
          const candidatos = Object.entries(playersObj)
            .filter(([pid, p]) => pid !== clientId && p && p.connections && Object.keys(p.connections).length > 0)
            .map(([pid]) => pid);
          if (candidatos.length > 0) {
            const nuevoHostId = candidatos[0];
            await update(ref(db, `lobbies/${code}`), { hostId: nuevoHostId });
          } else {
            try { await remove(ref(db, `lobbies/${code}`)); } catch(e){}
          }
        }

        if (lobbyRef && lobbyCallback){
          off(lobbyRef, 'value', lobbyCallback);
          lobbyRef = null; lobbyCallback = null;
        }

        if (currentConnRef){
          try{ onDisconnect(currentConnRef).cancel(); }catch(e){}
          try{ await remove(currentConnRef); }catch(e){}
          currentConnRef = null;
        }

        try{ await remove(ref(db, `lobbies/${code}/players/${clientId}`)); }catch(e){}
      }catch(e){
        console.warn('Error al salir de la sala:', e);
      }

      // limpiar UI y volver a overlay
      lobbyCode = null;
      lastLobbyState = null;
      badgeEl.style.display='none'; badgeEl.textContent = 'Sala: -----';
      leaveRow.style.display='none';
      overlayEl.style.display='flex';
      playersCard.style.display='none';
      const s = document.getElementById("salida"); if (s) s.innerHTML = "";
      if (statusEl) statusEl.textContent = "";
      if (playersList) playersList.innerHTML = "";
      isHost = false; prevIsHost = false; playersConnected = 0;
      updateHostUI();
    }

    document.getElementById("btnLeave")?.addEventListener("click", leaveLobby);
    window.showToast = (msg)=>{ const el=document.getElementById('toast'); if(!el) return; el.textContent=msg; el.classList.add('show'); clearTimeout(window.__tT); window.__tT=setTimeout(()=>el.classList.remove('show'),2200); };

    // Overlay actions
    document.getElementById("btnCreateLobby")?.addEventListener("click", ()=>{
      const name = document.getElementById("playerName")?.value || "Host";
      createLobby(name);
    });
    document.getElementById("btnJoinLobby")?.addEventListener("click", ()=>{
      const name = document.getElementById("playerName")?.value || "Jugador";
      const code = (document.getElementById("lobbyCodeInput")?.value)||"";
      joinLobby(code, name);
    });
  </script>

</body>
</html>
