import React, { useEffect, useMemo, useRef, useState, useLayoutEffect } from "react";

// Preview en canvas sin el logo Imgur, usando logo local de assets/logo_reborn.png

const HEROES = [
  "Accursed","Amun-Ra","Andromeda","Arachna","Armadon","Behemoth","Blacksmith","Blood Hunter","Bombardier","Bubbles","Chronos","Corrupted Disciple","Defiler","Demented Shaman","Devourer","Doctor Repulsor","Drunken Master","Electrician","Ellonia","Empath","Fayde","Flint Beastwood","Flux","Forsaken Archer","Gauntlet","Gemini","Geomancer","Glacius","Grinex","Gunblade","Hammerstorm","Hellbringer","Jeraziah","Keeper of the Forest","King Klout","Kraken","Legionnaire","Lodestone","Magmus","Magebane","Maliken","Martyr","Midas","Monarch","Monkey King","Moon Queen","Moraxus","Myrmidon","Night Hound","Nomad","Nymphora","Ophelia","Pandamonium","Pebbles","Pestilence","Pharaoh","Plague Rider","Pollywog Priest","Predator","Prophet","Puppet Master","Pyromancer","Rampage","Rhapsody","Riftwalker","Sand Wraith","Scout","Silhouette","Sir Benzington","Slither","Solstice","Soul Reaper","Soulstealer","Swiftblade","Tempest","The Chipper","The Gladiator","The Madman","Thunderbringer","Torturer","Tundra","Valkyrie","Vindicator","Voodoo Jester","War Beast","Witch Slayer","Wretched Hag","Zephyr"
].sort();

const MATCHUPS_BASE = {
  "Blacksmith": { synergy: ["Swiftblade", "Moon Queen", "Forsaken Archer"], advantage: [], disadvantage: [] },
  "Blood Hunter": { synergy: [], advantage: ["Thunderbringer", "Wretched Hag"], disadvantage: [] },
  "Arachna": { synergy: ["Slither"], advantage: ["Pyromancer", "Thunderbringer", "Flint Beastwood", "Soulstealer"], disadvantage: ["Magebane"] },
  "Pestilence": { synergy: ["Voodoo Jester"], advantage: ["The Madman", "Grinex", "Scout", "Night Hound", "Predator"], disadvantage: ["Puppet Master"] },
  "Hellbringer": { synergy: ["Voodoo Jester", "Slither", "Magmus"], advantage: [], disadvantage: [] },
  "Magmus": { synergy: ["Myrmidon", "Witch Slayer", "Pollywog Priest", "Jeraziah", "Nymphora"], advantage: [], disadvantage: [] },
  "Voodoo Jester": { synergy: ["Swiftblade","Gemini","Gauntlet"], advantage: [], disadvantage: ["Doctor Repulsor"] },
  "Witch Slayer": {
    synergy: ["Amun-Ra","Magmus","Pandamonium"],
    advantage: ["Armadon","Amun-Ra"],
    disadvantage: ["Swiftblade","Predator","Jeraziah","Moraxus","Pebbles","Gunblade"]
  },
  "Slither": {
    synergy: ["Demented Shaman","Amun-Ra","Swiftblade","Vindicator","Arachna"],
    advantage: ["Armadon"],
    disadvantage: ["The Chipper","Arachna","Predator","Swiftblade","Jeraziah","Accursed","Pebbles"]
  },
  "Pandamonium": {
    synergy: ["Witch Slayer","Voodoo Jester","Monarch"],
    advantage: ["Predator"],
    disadvantage: ["Vindicator","Bubbles","Fayde"]
  },
  "Bubbles": {
    synergy: ["Magmus","Behemoth","Plague Rider"],
    advantage: ["Pandamonium","Voodoo Jester","Monarch","Hammerstorm","Rampage","Myrmidon","Flint Beastwood","Andromeda","Pyromancer"],
    disadvantage: ["Blood Hunter","Gunblade","Predator","Night Hound"]
  },
  "Empath": { synergy: ["Predator","Nomad"], advantage: [], disadvantage: [] },
  "Rampage": { synergy: [], advantage: ["Predator"], disadvantage: [] },
  "Pharaoh": { synergy: [], advantage: ["Devourer","Pandamonium","Rampage"], disadvantage: [] },
  "Magebane": { synergy: [], advantage: ["Amun-Ra"], disadvantage: [] },
  "Corrupted Disciple": { synergy: [], advantage: ["Predator"], disadvantage: [] },
  "Glacius": { synergy: ["Devourer","Swiftblade"], advantage: [], disadvantage: [] },
  "Electrician": { synergy: ["Swiftblade"], advantage: [], disadvantage: [] },
  "King Klout": { synergy: [], advantage: ["Devourer","Pandamonium"], disadvantage: [] },
  "Swiftblade": { synergy: [], advantage: ["Predator"], disadvantage: [] },
  "Moraxus": { synergy: [], advantage: ["Pollywog Priest"], disadvantage: [] },
  "Vindicator": { synergy: [], advantage: ["Tempest"], disadvantage: [] },
  "The Chipper": { synergy: [], advantage: ["Thunderbringer","Pyromancer"], disadvantage: [] },
  "Bombardier": { synergy: [], advantage: [], disadvantage: ["Arachna","The Chipper","Accursed","Jeraziah"] },
  "Flux": { synergy: ["Behemoth","Tempest","Soulstealer","Geomancer","Kraken","Solstice","Legionnaire","Hellbringer"], advantage: [], disadvantage: [] },
  "Hammerstorm": { synergy: ["Rhapsody","Glacius","Monarch"], advantage: [], disadvantage: [] },
  "Ophelia": { synergy: [], advantage: [], disadvantage: ["Glacius","Voodoo Jester","Behemoth"] }
};

const HERO_IMAGES = {};
const IMAGE_BASE = "./assets/hon";

function deriveMatchups(base) {
  const allHeroes = new Set(HEROES);
  const out = {};
  for (const h of allHeroes) {
    const e = base[h] || {};
    out[h] = {
      synergy: Array.from(new Set(e.synergy || [])),
      advantage: Array.from(new Set(e.advantage || [])),
      disadvantage: Array.from(new Set(e.disadvantage || []))
    };
  }
  for (const a of Object.keys(out)) {
    for (const b of out[a].synergy) if (allHeroes.has(b) && !out[b].synergy.includes(a)) out[b].synergy.push(a);
    for (const b of out[a].advantage) if (allHeroes.has(b) && !out[b].disadvantage.includes(a)) out[b].disadvantage.push(a);
    for (const b of out[a].disadvantage) if (allHeroes.has(b) && !out[b].advantage.includes(a)) out[b].advantage.push(a);
  }
  for (const h of Object.keys(out)) {
    const clean = (arr)=>Array.from(new Set(arr.filter(x=>x && x!==h))).sort();
    out[h].synergy = clean(out[h].synergy);
    out[h].advantage = clean(out[h].advantage);
    out[h].disadvantage = clean(out[h].disadvantage);
  }
  return out;
}

const MATCHUPS = deriveMatchups(MATCHUPS_BASE);

function Avatar({ name, size = 24 }) {
  const [i, setI] = useState(0);
  const localURL = (filename) => new URL(`${IMAGE_BASE}/${filename}`, window.location.href).href;
  const fileStem = name.replace(/\s+/g, "_");
  const candidates = [
    localURL(`${fileStem}.webp`),
    localURL(`${fileStem}.png`),
    localURL(`${fileStem}.jpg`),
    HERO_IMAGES[name] || null,
  ].filter(Boolean);

  const src = i < candidates.length ? candidates[i] : null;
  const dim = `${size}px`;
  const initials = name.split(" ").map(p=>p[0]).join("").slice(0,2).toUpperCase();

  return (
    <div style={{ width: dim, height: dim }} className="inline-flex items-center justify-center rounded-lg bg-slate-700 text-slate-100 overflow-hidden">
      {src ? (
        <img src={src} alt={name} decoding="async" onError={() => setI(idx => idx + 1)} style={{ width: "100%", height: "100%", objectFit: "cover" }} />
      ) : (
        <span style={{ fontSize: size > 32 ? 14 : 12 }} className="font-semibold">{initials}</span>
      )}
    </div>
  );
}

export default function App(){
  const [query,setQuery]=useState("");
  const [open,setOpen]=useState(false);
  const [highlight,setHighlight]=useState(0);
  const [selected,setSelected]=useState(null);
  const containerRef=useRef(null);
  const panelRef=useRef(null);
  const [panelMinHeight, setPanelMinHeight] = useState(320);
  useLayoutEffect(()=>{ if(panelRef.current){ const h = panelRef.current.offsetHeight; setPanelMinHeight(prev=> Math.max(prev, h)); } }, [selected]);

  const filtered=useMemo(()=>{
    const q=query.trim().toLowerCase();
    const list=!q?HEROES:HEROES.filter(h=>h.toLowerCase().includes(q));
    return [...list].sort();
  },[query]);

  useEffect(()=>{
    function onClickOutside(e){ if(containerRef.current && !containerRef.current.contains(e.target)) setOpen(false); }
    window.addEventListener("mousedown",onClickOutside);
    return()=>window.removeEventListener("mousedown",onClickOutside);
  },[]);

  function choose(hero){ setSelected(hero); setQuery(hero); setOpen(false); try{window.scrollTo({top:0,behavior:'smooth'})}catch{} }
  const data=selected?MATCHUPS[selected]:null;

  function ResultItem({hero}){
    return (
      <button type="button" onClick={()=>choose(hero)} className="group w-full text-left flex items-center gap-2 rounded-xl px-2 py-1.5 hover:bg-slate-700 focus:bg-slate-700 focus:outline-none transition" aria-label={`Open ${hero} matchups`}>
        <Avatar name={hero} />
        <span className="underline decoration-transparent group-hover:decoration-slate-300">{hero}</span>
      </button>
    );
  }

  return (
    <div className="min-h-screen bg-slate-900 text-slate-100 flex items-center justify-center p-6">
      <div className="w-full max-w-3xl">
        <header className="mb-6 text-center">
          <img
            src="./assets/logo_reborn.png"
            alt="HoN Matchups Logo"
            className="mx-auto mb-3 h-12 sm:h-14 md:h-16 w-auto drop-shadow-[0_4px_10px_rgba(0,0,0,0.45)]"
            decoding="async"
          />
          <h1 className="text-3xl font-bold">HoN Matchups</h1>
          <p className="text-slate-400">Hero synergy and matchup finder</p>
        </header>

        <div className="relative" ref={containerRef}>
          <div className="relative flex justify-center">
            <input type="text" placeholder="Search hero…" value={query} onChange={(e)=>{setQuery(e.target.value); setOpen(true);}} onFocus={()=>{ setQuery(""); setOpen(true); }} className="w-96 max-w-full rounded-2xl border border-slate-700 bg-slate-800 text-slate-100 placeholder:text-slate-400 pl-4 pr-4 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-sky-400" />
          </div>
          {open && (
            <ul className="absolute z-10 mt-2 max-h-72 w-96 max-w-full left-1/2 -translate-x-1/2 overflow-auto rounded-2xl border border-slate-700 bg-slate-800 p-1 shadow-xl">
              {filtered.map((hero,idx)=>(
                <li key={hero} onClick={()=>choose(hero)} onMouseEnter={()=>setHighlight(idx)} className={`cursor-pointer rounded-xl px-3 py-2 text-sm flex items-center gap-2 ${idx===highlight?"bg-slate-700":""}`}>
                  <Avatar name={hero} />
                  <span>{hero}</span>
                </li>
              ))}
            </ul>
          )}
        </div>

        {selected && data && (
          <div ref={panelRef} style={{minHeight: panelMinHeight}} className="mt-8 rounded-2xl border border-slate-700 bg-slate-800 p-4 shadow-sm">
            <div className="flex items-center gap-4 mb-4">
              <Avatar name={selected} size={72} />
              <h2 className="text-2xl font-semibold">{selected}</h2>
            </div>
            <div className="grid gap-4 md:grid-cols-3">
              <div>
                <h3 className="font-semibold text-sky-300">Best Partners</h3>
                <ul className="mt-2 flex flex-col gap-2">
                  {data.synergy.length ? data.synergy.map(h => (<li key={h}><ResultItem hero={h} /></li>)) : <li className="text-sm text-slate-400">No data</li>}
                </ul>
              </div>
              <div>
                <h3 className="font-semibold text-green-400">Strong Against</h3>
                <ul className="mt-2 flex flex-col gap-2">
                  {data.advantage.length ? data.advantage.map(h => (<li key={h}><ResultItem hero={h} /></li>)) : <li className="text-sm text-slate-400">No data</li>}
                </ul>
              </div>
              <div>
                <h3 className="font-semibold text-red-400">Weak Against</h3>
                <ul className="mt-2 flex flex-col gap-2">
                  {data.disadvantage.length ? data.disadvantage.map(h => (<li key={h}><ResultItem hero={h} /></li>)) : <li className="text-sm text-slate-400">No data</li>}
                </ul>
              </div>
            </div>
          </div>
        )}

        <footer className="mt-10 text-center text-xs text-slate-400">
          <p>Developed by Nicket</p>
          <p>v27s — Stable</p>
        </footer>
      </div>
    </div>
  );
}
